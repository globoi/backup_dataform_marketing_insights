config {
  type: "table",
  name: "pesquisa_assinantes_3_dias_dados_tratados",
  schema: "pesquisas"
}

WITH
dados_brutos AS (
  SELECT
    respondent_id,
    collector_id,
    PARSE_DATETIME("%m/%d/%Y %I:%M:%S %p" , date_created) as date_created,
    PARSE_DATETIME("%m/%d/%Y %I:%M:%S %p" , date_modified) as date_modified,
    ip_address,
    email_address,
    first_name,
    last_name,
    custom_1,
    Qual_a_chance_de_voc___recomendar_o_Globoplay_para_um_amigo_ou_familiar_ AS Qual_a_chance_de_voce_recomendar_o_Globoplay_para_um_amigo_ou_familiar,
    Como_foi_sua_experi__ncia_ao_assinar_o_Globoplay_ AS  Como_foi_sua_experiencia_ao_assinar_o_Globoplay,
    O_que_motivou_voc___a_assinar_Globoplay_ AS O_que_motivou_voce_a_assinar_Globoplay_1,
    string_field_12 AS O_que_motivou_voce_a_assinar_Globoplay_2,
    string_field_13 AS O_que_motivou_voce_a_assinar_Globoplay_3,
    string_field_14 AS O_que_motivou_voce_a_assinar_Globoplay_4,
    string_field_15 AS O_que_motivou_voce_a_assinar_Globoplay_5,
    string_field_16 AS O_que_motivou_voce_a_assinar_Globoplay_6,
    string_field_17 AS O_que_motivou_voce_a_assinar_Globoplay_7,
    string_field_18 AS O_que_motivou_voce_a_assinar_Globoplay_8,
    string_field_19 AS O_que_motivou_voce_a_assinar_Globoplay_9,
    string_field_20 AS O_que_motivou_voce_a_assinar_Globoplay_10,
    string_field_21 AS O_que_motivou_voce_a_assinar_Globoplay_11,
    string_field_22 AS O_que_motivou_voce_a_assinar_Globoplay_12,
    Qual_desses_motivos_foi_o_mais_importante_ AS Qual_desses_motivos_foi_o_mais_importante,
    Voc___assinou___ AS Voce_assinou,
    string_field_25 AS Assinou_Conteudo_Especifico,
    Voc___assinou_um_plano_com_os_canais_ao_vivo__Sportv__GloboNews__Multishow____ AS Voce_assinou_um_plano_com_os_canais_ao_vivo__Sportv__GloboNews__Multishow,
    O_que_te_motivou_a_assinar_o_Globoplay___Canais_ao_vivo_ AS Canais_1,
    string_field_28 AS Canais_2,
    string_field_29 AS Canais_3,
    string_field_30 AS Canais_4,
    string_field_31 AS Canais_5,
    string_field_32 AS Canais_6,
    string_field_33 AS Canais_7,
    string_field_34 AS Canais_8,
    string_field_35 AS Canais_9,
    string_field_36 AS Canais_10,
    string_field_37 AS Canais_11,
    string_field_38 AS Canais_12,
    string_field_39 AS Canais_13,
    string_field_40 AS Canais_14,
    string_field_41 AS Canais_15,
    string_field_42 AS Canais_16,
    string_field_43 AS Canais_17,
    Em_ordem_de_prefer__ncia__qual_desses_mais_te_motivou_a_assinar_ AS Ordem_TV_Globo,
    string_field_45 AS Ordem_Sportv,
    string_field_46 AS Ordem_Viva,
    string_field_47 AS Ordem_GloboNews,
    string_field_48 AS Ordem_Multishow,
    string_field_49 AS Ordem_GNT,
    string_field_50 AS Ordem_Megapix,
    string_field_51 AS Ordem_Universal,
    string_field_52 AS Ordem_Gloob,
    string_field_53 AS Ordem_Gloobinjo,
    string_field_54 AS Ordem_Canal_Brasil,
    string_field_55 AS Ordem_Studio_Universal,
    string_field_56 AS Ordem_Off,
    string_field_57 AS Ordem_Modo_Viagem,
    string_field_58 AS Ordem_Bis,
    string_field_59 AS Ordem_SyFy,
    string_field_60 AS Ordem_Conteudos_Globoplay,
    Quais_conte__dos_foram_o_seu_interesse_ao_assinar_o_Globoplay_ AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay,
    string_field_62 AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_2,
    string_field_63 AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_3,
    string_field_64 AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_4,
    string_field_65 AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_5,
    string_field_66 AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_6,
    string_field_67 AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_7,
    string_field_68 AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_8,
    string_field_69 AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_9,
    string_field_70 AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_10,
    string_field_71 AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_11,
    string_field_72 AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_12,
    string_field_73 AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_13,
    string_field_74 AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_14,
    string_field_75 AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_15, 
    Sei_que_pode_ser_dif__cil_mas_se_voc___precisasse_ordenar_do_mais_importante_para_o_menos_importante__como_voc___ordenaria_ AS Ordem_Filmes_Internacionais,
    string_field_77 AS Ordem_Novelas_Nacionais,
    string_field_78 AS Ordem_Series_Internacionais,
    string_field_79 AS Ordem_Originais,
    string_field_80 AS Ordem_Series_Nacionais,
    string_field_81 AS Ordem_Filmes_Nacionais,
    string_field_82 AS Ordem_Jornalismo,
    string_field_83 AS Ordem_Conteudo_AoVIvo,
    string_field_84 AS Ordem_Reality,
    string_field_85 AS Ordem_Variedades,
    string_field_86 AS Ordem_Infantil,
    string_field_87 AS Ordem_Novelas_Internacionais,
    string_field_88 AS Ordem_Humor,
    string_field_89 AS Ordem_Musical,
    string_field_90 AS Ordem_Esportes,
    Quais_servi__os_abaixo_voc___assina_ AS Quais_servicos_abaixo_voce_assina_1,
    string_field_92 AS Quais_servicos_abaixo_voce_assina_2,
    string_field_93 AS Quais_servicos_abaixo_voce_assina_3,
    string_field_94 AS Quais_servicos_abaixo_voce_assina_4,
    string_field_95 AS Quais_servicos_abaixo_voce_assina_5,
    string_field_96 AS Quais_servicos_abaixo_voce_assina_6,
    string_field_97 AS Quais_servicos_abaixo_voce_assina_7,
    string_field_98 AS Quais_servicos_abaixo_voce_assina_8,
    string_field_99 AS Quais_servicos_abaixo_voce_assina_9,
    string_field_100 AS Quais_servicos_abaixo_voce_assina_10,
    string_field_101 AS Quais_servicos_abaixo_voce_assina_11,
    string_field_102 AS Quais_servicos_abaixo_voce_assina_12,
    string_field_103 AS Quais_servicos_abaixo_voce_assina_13,
    string_field_104 AS Quais_servicos_abaixo_voce_assina_14,
    string_field_105 AS Quais_servicos_abaixo_voce_assina_15,
    string_field_106 AS Quais_servicos_abaixo_voce_assina_16,
    string_field_107 AS Quais_servicos_abaixo_voce_assina_17,
    Qual_desses____o_seu_favorito_ AS Qual_desses_e_o_seu_favorito,
    Voc___pretende_manter_sua_assinatura_com_a_gente_por_quanto_tempo_ AS Voce_pretende_manter_sua_assinatura_com_a_gente_por_quanto_tempo,
    userid
  FROM
    ${ref("pesquisas", "pesquisa_assinantes_3_dias_dados_brutos")}
),

ultima_comunicacao AS (
  SELECT
    globo_id,
    tipo_assinante,
    mais_canais,
    addon_disney,
    addon_deezer,
    dt_assinatura_comeco,
    canal_compra,
    produto,
    tempo_de_base_agrupado,
    gender,
    age,
    first_play,
    flag_recebeu_email_30D,
    flag_abriu_email_30D,
    flag_recebeu_push_30D,
    flag_abriu_app_30D,
    flag_abriu_push_30D,
    Perfil_uso_push,
    perfil_email,
    produto_contratado
  FROM
    ${ref("comunicacao", "ultima_comunicacao_assinante")}
)

SELECT
  * EXCEPT(globo_id)
FROM
  dados_brutos db
  LEFT JOIN ultima_comunicacao uc 
  ON db.userid = uc.globo_id
QUALIFY
  ROW_NUMBER() OVER(PARTITION BY respondent_id ORDER BY respondent_id) = 1