config {
  type: "table",
  name: "pesquisa_assinantes_3_dias_dados_tratados_new",
  schema: "pesquisas",
  tags: ["pesquisas_staging_9",
        "schedule_tag=pesquisa_pesquisa_assinantes_3_dias_dados_tratados_new",
        "schedule_cron=30 11 * * *"
  ]
}

WITH
dados_brutos AS (
  SELECT
    respondent_id,
    collector_id,
    datetime(date_modified, 'America/Sao_Paulo') as date_modified,
    datetime(date_created, 'America/Sao_Paulo') as date_created,
    ip_address,
    email_address,
    first_name,
    last_name,
    null as custom_1,
    qual_a_chance_de_voce_recomendar_o_globoplay_para_um_amigo_ou_familiar AS Qual_a_chance_de_voce_recomendar_o_Globoplay_para_um_amigo_ou_familiar,
    como_foi_sua_experiencia_ao_assinar_o_globoplay AS  Como_foi_sua_experiencia_ao_assinar_o_Globoplay,
    o_que_motivou_voce_a_assinar_globoplay_Nenhuma_das_anteriores AS O_que_motivou_voce_a_assinar_Globoplay_1,
    o_que_motivou_voce_a_assinar_globoplay_Anuncio_na_TV AS O_que_motivou_voce_a_assinar_Globoplay_2,
    o_que_motivou_voce_a_assinar_globoplay_Anuncio_na_rua_outdoor_busdoor_ou_outro_mobiliario_urbano AS O_que_motivou_voce_a_assinar_Globoplay_3,
o_que_motivou_voce_a_assinar_globoplay_Estava_vendo_um_conteudo_na_TV_serie_filme_reality_etc_e_me_interessei_em_assistir_no_Globoplay AS O_que_motivou_voce_a_assinar_Globoplay_4,
    o_que_motivou_voce_a_assinar_globoplay_Anuncio_no_Google AS O_que_motivou_voce_a_assinar_Globoplay_5,
    o_que_motivou_voce_a_assinar_globoplay_Anuncios_em_redes_sociais_Facebook_Instagram_Tiktok_etc AS O_que_motivou_voce_a_assinar_Globoplay_6,
    o_que_motivou_voce_a_assinar_globoplay_Anuncio_em_outro_siteapp AS O_que_motivou_voce_a_assinar_Globoplay_7,
    o_que_motivou_voce_a_assinar_globoplay_Indicacao_de_amigos AS O_que_motivou_voce_a_assinar_Globoplay_8,
    o_que_motivou_voce_a_assinar_globoplay_Anuncio_em_outro_meio AS O_que_motivou_voce_a_assinar_Globoplay_9,
    o_que_motivou_voce_a_assinar_globoplay_Segui_a_dica_de_um_criador_de_conteudo_influenciador_ou_pessoa_em_rede_social AS O_que_motivou_voce_a_assinar_Globoplay_10,
    o_que_motivou_voce_a_assinar_globoplay_Li_um_artigo_reportagem AS O_que_motivou_voce_a_assinar_Globoplay_11,
    o_que_motivou_voce_a_assinar_globoplay_Anuncio_por_email_ou_notificacao_no_celular AS O_que_motivou_voce_a_assinar_Globoplay_12,
    qual_desses_motivos_foi_o_mais_importante_ AS Qual_desses_motivos_foi_o_mais_importante,
    voce_assinou_ AS Voce_assinou,
    voce_assinou_other_ AS Assinou_Conteudo_Especifico,
    voce_assinou_um_plano_com_os_canais_ao_vivo_sportv_globonews_multishow AS Voce_assinou_um_plano_com_os_canais_ao_vivo__Sportv__GloboNews__Multishow,
    voce_assinou_um_plano_premium_com_os_canais_ao_vivo_sportv_globonews_multishow as Voce_assinou_um_plano_premium_com_os_canais_ao_vivo_Sportv_GloboNews_Multishow,
    coalesce(o_que_te_motivou_a_assinar_o_globoplay_premium_TV_Globo,o_que_te_motivou_a_assinar_o_globoplay_canais_ao_vivo_TV_Globo) AS Canais_1,
    coalesce(o_que_te_motivou_a_assinar_o_globoplay_premium_Sportv,o_que_te_motivou_a_assinar_o_globoplay_canais_ao_vivo_Sportv) AS Canais_2,
    coalesce(o_que_te_motivou_a_assinar_o_globoplay_premium_VIVA,o_que_te_motivou_a_assinar_o_globoplay_canais_ao_vivo_VIVA) AS Canais_3,
    coalesce(o_que_te_motivou_a_assinar_o_globoplay_premium_GloboNews,o_que_te_motivou_a_assinar_o_globoplay_canais_ao_vivo_GloboNews) AS Canais_4,
    coalesce(o_que_te_motivou_a_assinar_o_globoplay_premium_Multishow,o_que_te_motivou_a_assinar_o_globoplay_canais_ao_vivo_Multishow) AS Canais_5,
    coalesce(o_que_te_motivou_a_assinar_o_globoplay_premium_GNT,o_que_te_motivou_a_assinar_o_globoplay_canais_ao_vivo_GNT) AS Canais_6,
    coalesce(o_que_te_motivou_a_assinar_o_globoplay_premium_Megapix,o_que_te_motivou_a_assinar_o_globoplay_canais_ao_vivo_Megapix) AS Canais_7,
    coalesce(o_que_te_motivou_a_assinar_o_globoplay_premium_Universal,o_que_te_motivou_a_assinar_o_globoplay_canais_ao_vivo_Universal) AS Canais_8,
    coalesce(o_que_te_motivou_a_assinar_o_globoplay_premium_Gloob,o_que_te_motivou_a_assinar_o_globoplay_canais_ao_vivo_Gloob) AS Canais_9,
    coalesce(o_que_te_motivou_a_assinar_o_globoplay_premium_Gloobinho,o_que_te_motivou_a_assinar_o_globoplay_canais_ao_vivo_Gloobinho) AS Canais_10,
    coalesce(o_que_te_motivou_a_assinar_o_globoplay_premium_Canal_Brasil,o_que_te_motivou_a_assinar_o_globoplay_canais_ao_vivo_Canal_Brasil) AS Canais_11,
    coalesce(o_que_te_motivou_a_assinar_o_globoplay_premium_Studio_Universal,o_que_te_motivou_a_assinar_o_globoplay_canais_ao_vivo_Studio_Universal) AS Canais_12,
    coalesce(o_que_te_motivou_a_assinar_o_globoplay_premium_OFF,o_que_te_motivou_a_assinar_o_globoplay_canais_ao_vivo_OFF) AS Canais_13,
    coalesce(o_que_te_motivou_a_assinar_o_globoplay_premium_Modo_Viagem,o_que_te_motivou_a_assinar_o_globoplay_canais_ao_vivo_Modo_Viagem) AS Canais_14,
    coalesce(o_que_te_motivou_a_assinar_o_globoplay_premium_Bis,o_que_te_motivou_a_assinar_o_globoplay_canais_ao_vivo_Bis) AS Canais_15,
    o_que_te_motivou_a_assinar_o_globoplay_canais_ao_vivo_SyFy AS Canais_16,
coalesce(o_que_te_motivou_a_assinar_o_globoplay_premium_Conteudos_proprios_Globoplay_Ex_filmes_series_novelas_documentarios_podcasts_entre_outros,o_que_te_motivou_a_assinar_o_globoplay_canais_ao_vivo_Conteudos_proprios_Globoplay_Ex_filmes_series_novelas_documentarios_podcasts_entre_outros) AS Canais_17,
o_que_te_motivou_a_assinar_o_globoplay_premium_USA as Canais_18,
    em_ordem_de_preferencia_qual_desses_mais_te_motivou_a_assinar_tv_globo_ AS Ordem_TV_Globo,
    em_ordem_de_preferencia_qual_desses_mais_te_motivou_a_assinar_sportv_ AS Ordem_Sportv,
    em_ordem_de_preferencia_qual_desses_mais_te_motivou_a_assinar_viva_ AS Ordem_Viva,
    em_ordem_de_preferencia_qual_desses_mais_te_motivou_a_assinar_globonews_ AS Ordem_GloboNews,
    em_ordem_de_preferencia_qual_desses_mais_te_motivou_a_assinar_multishow_ AS Ordem_Multishow,
    em_ordem_de_preferencia_qual_desses_mais_te_motivou_a_assinar_gnt_ AS Ordem_GNT,
    em_ordem_de_preferencia_qual_desses_mais_te_motivou_a_assinar_megapix_ AS Ordem_Megapix,
    em_ordem_de_preferencia_qual_desses_mais_te_motivou_a_assinar_universal_ AS Ordem_Universal,
    em_ordem_de_preferencia_qual_desses_mais_te_motivou_a_assinar_gloob_ AS Ordem_Gloob,
    em_ordem_de_preferencia_qual_desses_mais_te_motivou_a_assinar_gloobinho_ AS Ordem_Gloobinho,
    em_ordem_de_preferencia_qual_desses_mais_te_motivou_a_assinar_canal_brasil_ AS Ordem_Canal_Brasil,
    em_ordem_de_preferencia_qual_desses_mais_te_motivou_a_assinar_studio_universal_ AS Ordem_Studio_Universal,
    em_ordem_de_preferencia_qual_desses_mais_te_motivou_a_assinar_off_ AS Ordem_Off,
    em_ordem_de_preferencia_qual_desses_mais_te_motivou_a_assinar_modo_viagem_ AS Ordem_Modo_Viagem,
    em_ordem_de_preferencia_qual_desses_mais_te_motivou_a_assinar_bis_ AS Ordem_Bis,
    em_ordem_de_preferencia_qual_desses_mais_te_motivou_a_assinar_syfy_ AS Ordem_SyFy,
    em_ordem_de_preferencia_qual_desses_mais_te_motivou_a_assinar_usa_ as Ordem_USA,
em_ordem_de_preferencia_qual_desses_mais_te_motivou_a_assinar_conteudos_proprios_globoplay_ex_filmes_series_novelas_documentarios_podcasts_entre_outros_ AS Ordem_Conteudos_Globoplay,
    quais_conteudos_foram_o_seu_interesse_ao_assinar_o_globoplay_Filmes_internacionais AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay,
    quais_conteudos_foram_o_seu_interesse_ao_assinar_o_globoplay_Novelas_Nacionais AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_2,
    quais_conteudos_foram_o_seu_interesse_ao_assinar_o_globoplay_Series_Internacionais AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_3,
    quais_conteudos_foram_o_seu_interesse_ao_assinar_o_globoplay_Originais_Globoplay AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_4,
    quais_conteudos_foram_o_seu_interesse_ao_assinar_o_globoplay_Series_Nacionais AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_5,
    quais_conteudos_foram_o_seu_interesse_ao_assinar_o_globoplay_Filmes_Nacionais AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_6,
    quais_conteudos_foram_o_seu_interesse_ao_assinar_o_globoplay_Jornalismo AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_7,
    quais_conteudos_foram_o_seu_interesse_ao_assinar_o_globoplay_Conteudo_ao_vivo AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_8,
    quais_conteudos_foram_o_seu_interesse_ao_assinar_o_globoplay_Realites_Show_BBB_The_Voice AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_9,
    quais_conteudos_foram_o_seu_interesse_ao_assinar_o_globoplay_Programas_de_Variedade_Encontro_Mais_Voce_Tempero_de_Familia AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_10,
    quais_conteudos_foram_o_seu_interesse_ao_assinar_o_globoplay_Infantil AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_11,
    quais_conteudos_foram_o_seu_interesse_ao_assinar_o_globoplay_Novelas_Internacionais AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_12,
    quais_conteudos_foram_o_seu_interesse_ao_assinar_o_globoplay_Humor AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_13,
    quais_conteudos_foram_o_seu_interesse_ao_assinar_o_globoplay_Conteudos_Musicais AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_14,
    quais_conteudos_foram_o_seu_interesse_ao_assinar_o_globoplay_Esportes AS Quais_conteudos_foram_o_seu_interesse_ao_assinar_o_Globoplay_15, 
sei_que_pode_ser_dificil_mas_se_voce_precisasse_ordenar_do_mais_importante_para_o_menos_importante_como_voce_ordenaria_filmes_internacionais_ AS Ordem_Filmes_Internacionais,
sei_que_pode_ser_dificil_mas_se_voce_precisasse_ordenar_do_mais_importante_para_o_menos_importante_como_voce_ordenaria_novelas_nacionais_ AS Ordem_Novelas_Nacionais,
    sei_que_pode_ser_dificil_mas_se_voce_precisasse_ordenar_do_mais_importante_para_o_menos_importante_como_voce_ordenaria_series_internacionais_ AS Ordem_Series_Internacionais,
    sei_que_pode_ser_dificil_mas_se_voce_precisasse_ordenar_do_mais_importante_para_o_menos_importante_como_voce_ordenaria_originais_globoplay_ AS Ordem_Originais,
    sei_que_pode_ser_dificil_mas_se_voce_precisasse_ordenar_do_mais_importante_para_o_menos_importante_como_voce_ordenaria_series_nacionais_ AS Ordem_Series_Nacionais,
    sei_que_pode_ser_dificil_mas_se_voce_precisasse_ordenar_do_mais_importante_para_o_menos_importante_como_voce_ordenaria_filmes_nacionais_ AS Ordem_Filmes_Nacionais,
    sei_que_pode_ser_dificil_mas_se_voce_precisasse_ordenar_do_mais_importante_para_o_menos_importante_como_voce_ordenaria_jornalismo_ AS Ordem_Jornalismo,
    sei_que_pode_ser_dificil_mas_se_voce_precisasse_ordenar_do_mais_importante_para_o_menos_importante_como_voce_ordenaria_conteudo_ao_vivo_ AS Ordem_Conteudo_AoVIvo,
    sei_que_pode_ser_dificil_mas_se_voce_precisasse_ordenar_do_mais_importante_para_o_menos_importante_como_voce_ordenaria_realites_show_bbb_the_voice_ AS Ordem_Reality,
    sei_que_pode_ser_dificil_mas_se_voce_precisasse_ordenar_do_mais_importante_para_o_menos_importante_como_voce_ordenaria_programas_de_variedade_encontro_mais_voce_tempero_de_familia_ AS Ordem_Variedades,
    sei_que_pode_ser_dificil_mas_se_voce_precisasse_ordenar_do_mais_importante_para_o_menos_importante_como_voce_ordenaria_infantil_ AS Ordem_Infantil,
    sei_que_pode_ser_dificil_mas_se_voce_precisasse_ordenar_do_mais_importante_para_o_menos_importante_como_voce_ordenaria_novelas_internacionais_ AS Ordem_Novelas_Internacionais,
    sei_que_pode_ser_dificil_mas_se_voce_precisasse_ordenar_do_mais_importante_para_o_menos_importante_como_voce_ordenaria_humor_ AS Ordem_Humor,
    sei_que_pode_ser_dificil_mas_se_voce_precisasse_ordenar_do_mais_importante_para_o_menos_importante_como_voce_ordenaria_conteudos_musicais_ AS Ordem_Musical,
    sei_que_pode_ser_dificil_mas_se_voce_precisasse_ordenar_do_mais_importante_para_o_menos_importante_como_voce_ordenaria_esportes_ AS Ordem_Esportes,
    quais_servicos_abaixo_voce_assina_Netflix AS Quais_servicos_abaixo_voce_assina_1,
    quais_servicos_abaixo_voce_assina_Star AS Quais_servicos_abaixo_voce_assina_2,
    quais_servicos_abaixo_voce_assina_Spotify_Premium AS Quais_servicos_abaixo_voce_assina_3,
    quais_servicos_abaixo_voce_assina_Apple_TV_ AS Quais_servicos_abaixo_voce_assina_4,
    quais_servicos_abaixo_voce_assina_Deezer_Premium AS Quais_servicos_abaixo_voce_assina_5,
    quais_servicos_abaixo_voce_assina_Starz_Play_Lionsgate AS Quais_servicos_abaixo_voce_assina_6,
    quais_servicos_abaixo_voce_assina_Amazon_Prime_Video AS Quais_servicos_abaixo_voce_assina_7,
    quais_servicos_abaixo_voce_assina_Paramount_ AS Quais_servicos_abaixo_voce_assina_8,
    quais_servicos_abaixo_voce_assina_DirecTV_Go AS Quais_servicos_abaixo_voce_assina_9,
    quais_servicos_abaixo_voce_assina_Youtube_Premium AS Quais_servicos_abaixo_voce_assina_10,
    coalesce(quais_servicos_abaixo_voce_assina_Max_antigo_HBO_Max,quais_servicos_abaixo_voce_assina_HBO_Max) AS Quais_servicos_abaixo_voce_assina_11,
    coalesce(quais_servicos_abaixo_voce_assina_Telecine,quais_servicos_abaixo_voce_assina_Telecine_Play,quais_servicos_abaixo_voce_assina_Telecine_Play) AS Quais_servicos_abaixo_voce_assina_12,
    coalesce(quais_servicos_abaixo_voce_assina_Premiere_Play,quais_servicos_abaixo_voce_assina_Premiere,quais_servicos_abaixo_voce_assina_Premiere_Play) AS Quais_servicos_abaixo_voce_assina_13,
    quais_servicos_abaixo_voce_assina_Disney_ AS Quais_servicos_abaixo_voce_assina_14,
    quais_servicos_abaixo_voce_assina_Tv_a_cabo_satelite AS Quais_servicos_abaixo_voce_assina_15,
    quais_servicos_abaixo_voce_assina_Discovery_ AS Quais_servicos_abaixo_voce_assina_16,
    quais_servicos_abaixo_voce_assina_Nao_assino_outros_servicos AS Quais_servicos_abaixo_voce_assina_17,
    quais_servicos_abaixo_voce_assina_other_ as Quais_servicos_abaixo_voce_assina_18,
    quais_servicos_abaixo_voce_assina_Combate as Quais_servicos_abaixo_voce_assina_19,
    qual_desses_e_o_seu_favorito_ AS Qual_desses_e_o_seu_favorito,
    voce_pretende_manter_sua_assinatura_com_a_gente_por_quanto_tempo_ AS Voce_pretende_manter_sua_assinatura_com_a_gente_por_quanto_tempo,
    user_id as userid
  FROM
    ${ref("pesquisas", "pesquisa_assinante_3")}
),

ultima_comunicacao AS (
  SELECT
    globo_id,
    tipo_assinante,
    mais_canais,
    dt_assinatura_comeco,
    canal_compra,
    produto,
    tempo_de_base_agrupado,
    gender,
    age,
    first_play,
    flag_recebeu_email_30D,
    flag_abriu_email_30D,
    flag_recebeu_push_30D,
    flag_abriu_app_30D,
    flag_abriu_push_30D,
    Perfil_uso_push,
    perfil_email,
    produto_contratado
  FROM
    ${ref("comunicacao", "ultima_comunicacao_assinante")}
)

SELECT
  * EXCEPT(globo_id)
FROM
  dados_brutos db
  LEFT JOIN ultima_comunicacao uc 
  ON db.userid = uc.globo_id
QUALIFY
  ROW_NUMBER() OVER(PARTITION BY respondent_id ORDER BY respondent_id) = 1